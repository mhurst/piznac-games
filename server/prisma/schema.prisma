// Prisma schema for Piznac Games
// Dev: SQLite | Prod: PostgreSQL (just change provider + url)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============= USERS =============

model User {
  id            String    @id @default(cuid())
  username      String    @unique
  email         String?   @unique
  passwordHash  String
  createdAt     DateTime  @default(now())
  lastSeenAt    DateTime  @default(now())

  // Relations
  stats         GameStats[]
  matchesAsP1   Match[]   @relation("Player1")
  matchesAsP2   Match[]   @relation("Player2")
  matchesWon    Match[]   @relation("Winner")

  @@index([username])
}

// ============= GAME STATS =============
// Per-user, per-game statistics

model GameStats {
  id            String   @id @default(cuid())
  userId        String
  gameType      String   // "tic-tac-toe", "connect-four", etc.

  wins          Int      @default(0)
  losses        Int      @default(0)
  draws         Int      @default(0)

  currentStreak Int      @default(0)  // Positive = wins, negative = losses
  bestWinStreak Int      @default(0)

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gameType])
  @@index([userId])
  @@index([gameType])
}

// ============= MATCH HISTORY =============

model Match {
  id            String   @id @default(cuid())
  gameType      String   // "tic-tac-toe", "connect-four"
  mode          String   // "multiplayer", "singleplayer"

  // Players (player2 null for SP games)
  player1Id     String
  player2Id     String?

  // Result
  winnerId      String?  // null = draw
  isDraw        Boolean  @default(false)

  // SP-specific
  aiDifficulty  String?  // "easy", "medium", "hard"

  // Metadata
  moves         Int      @default(0)
  durationSecs  Int?
  playedAt      DateTime @default(now())

  // Relations
  player1       User     @relation("Player1", fields: [player1Id], references: [id], onDelete: Cascade)
  player2       User?    @relation("Player2", fields: [player2Id], references: [id], onDelete: Cascade)
  winner        User?    @relation("Winner", fields: [winnerId], references: [id], onDelete: SetNull)

  @@index([player1Id])
  @@index([player2Id])
  @@index([gameType])
  @@index([playedAt])
}
